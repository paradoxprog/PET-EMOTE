<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet'emote: Main Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Variables for Warm Paws Theme */
        :root {
            --primary-color: #FF6B6B; /* Coral Red */
            --primary-hover: #EE5253; 
            --accent-color: #4ECDC4; /* Mint Teal */
            --bg-light: #FFF9F0; /* Warm Cream */
            --bg-dark: #2D2424; /* Dark Cocoa */
            --card-bg-light: #ffffff;
            --card-bg-dark: #3A3030; /* Lighter Cocoa */
            --text-color-light: #4A403A; /* Dark Brown Text */
            --text-color-dark: #F0E6D2; /* Cream Text */
            --border-color-light: #F0E6D2;
            --border-color-dark: #5C4B4B;
            --shadow-light: 0 10px 30px rgba(74, 64, 58, 0.08);
            --shadow-dark: 0 10px 30px rgba(0, 0, 0, 0.4);
            --header-bg-light: rgba(255, 255, 255, 0.95);
            --header-bg-dark: rgba(58, 48, 48, 0.95);
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-light);
            color: var(--text-color-light);
            transition: background-color 0.4s ease, color 0.4s ease;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            background-image: radial-gradient(var(--border-color-light) 2px, transparent 2px);
            background-size: 30px 30px;
        }

        body.dark {
            --bg-light: var(--bg-dark);
            --bg-dark: #2D2424;
            --card-bg-light: var(--card-bg-dark);
            --text-color-light: var(--text-color-dark);
            --border-color-light: var(--border-color-dark);
            --shadow-light: var(--shadow-dark);
            --header-bg-light: var(--header-bg-dark);
            background-image: radial-gradient(#3a3030 2px, transparent 2px);
        }

        /* Header */
        header {
            width: 100%;
            background-color: var(--header-bg-light);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 100;
            border-bottom: 3px solid var(--accent-color);
        }
        body.dark header { border-bottom-color: var(--primary-color); }

        header .logo-container { display: flex; align-items: center; }
        header img.logo { height: 60px; width: 60px; margin-right: 15px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); background: white; padding: 2px; }
        header h1.site-title { font-size: 28px; color: var(--primary-color); margin: 0; font-weight: 800; }

        nav { display: flex; align-items: center; }
        nav a {
            margin-left: 15px; text-decoration: none; color: var(--text-color-light);
            font-weight: 700; font-size: 16px; transition: all 0.3s ease;
            padding: 8px 16px; border-radius: 20px;
        }
        nav a:hover, nav a.active-nav-link {
            background-color: var(--primary-color); color: white;
            transform: translateY(-2px); box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        /* Main Content */
        main {
            width: 95%; max-width: 1000px; padding: 40px 30px; margin: 40px auto;
            background-color: var(--card-bg-light); border-radius: 30px;
            box-shadow: var(--shadow-light); overflow: hidden; position: relative;
            min-height: 500px; border: 1px solid var(--border-color-light);
        }
        body.dark main { border-color: var(--border-color-dark); }

        section {
            opacity: 0; transform: scale(0.98) translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            padding: 10px; max-width: 800px; margin: 0 auto; display: none;
        }
        section.active { opacity: 1; transform: scale(1) translateY(0); display: block; }

        h2.section-heading { text-align: center; margin-bottom: 30px; font-weight: 800; color: var(--primary-color); font-size: 32px; }
        h3, h4 { color: var(--text-color-light); margin-top: 25px; margin-bottom: 15px; font-weight: 700; }
        body.dark h3, body.dark h4 { color: var(--text-color-dark); }
        h3 { font-size: 24px; color: var(--accent-color); }
        p { font-size: 16px; line-height: 1.8; margin-bottom: 20px; color: var(--text-color-light); }
        body.dark p { color: var(--text-color-dark); }

        /* UI Elements */
        .file-input-wrapper {
            position: relative; overflow: hidden; display: inline-block; width: 100%;
            border: 2px dashed var(--accent-color); border-radius: 20px;
            background-color: rgba(78, 205, 196, 0.1); transition: all 0.3s ease;
        }
        .file-input { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-input-label { display: block; padding: 40px; text-align: center; color: var(--accent-color); cursor: pointer; font-weight: 700; }
        
        #imagePreview {
            max-width: 100%; max-height: 300px; border-radius: 20px; object-fit: contain;
            margin: 0 auto; display: none; border: 3px solid var(--border-color-light);
        }

        button {
            border-radius: 50px !important; font-weight: 800 !important; text-transform: uppercase;
            letter-spacing: 0.5px; padding: 16px 30px; border: none;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); font-family: 'Nunito', sans-serif;
            transition: all 0.3s ease; cursor: pointer;
        }
        button:hover { transform: translateY(-3px) scale(1.02); }

        .loading-spinner {
            border: 4px solid var(--border-color-light); border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
            margin: 20px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Chat & Results */
        #resultDisplay, #personalizedResultDisplay {
            background-color: var(--bg-light); padding: 25px; border-radius: 20px;
            text-align: left; border: 2px solid var(--border-color-light); margin-top: 20px;
        }
        body.dark #resultDisplay, body.dark #personalizedResultDisplay { background-color: var(--bg-dark); border-color: var(--border-color-dark); }

        .chatbot-container {
            max-width: 700px; margin: 0 auto; border: 2px solid var(--border-color-light);
            border-radius: 25px; overflow: hidden; display: flex; flex-direction: column;
            height: 60vh; background-color: var(--bg-light);
        }
        body.dark .chatbot-container { border-color: var(--border-color-dark); background-color: var(--bg-dark); }
        
        .chat-window { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { padding: 15px 20px; border-radius: 20px; max-width: 80%; line-height: 1.5; font-size: 15px; }
        .chat-message.user { background-color: var(--primary-color); color: white; align-self: flex-end; }
        .chat-message.bot { background-color: white; color: var(--text-color-light); align-self: flex-start; border: 1px solid var(--border-color-light); }
        body.dark .chat-message.bot { background-color: var(--card-bg-dark); color: var(--text-color-dark); border-color: var(--border-color-dark); }
        
        .chat-input-area { display: flex; padding: 15px; border-top: 1px solid var(--border-color-light); background-color: white; gap: 10px; }
        body.dark .chat-input-area { border-top-color: var(--border-color-dark); background-color: var(--header-bg-dark); }
        
        #chat-input { flex-grow: 1; padding: 12px 20px; border: 2px solid var(--border-color-light); border-radius: 25px; background-color: var(--bg-light); color: var(--text-color-light); outline: none; }
        body.dark #chat-input { background-color: var(--bg-dark); color: var(--text-color-dark); border-color: var(--border-color-dark); }

        /* Inputs */
        input[type="text"], input[type="number"] {
            width: 100%; padding: 15px 20px; border: 2px solid var(--border-color-light);
            border-radius: 15px; background-color: var(--bg-light); color: var(--text-color-light);
            margin-bottom: 20px;
        }
        body.dark input[type="text"], body.dark input[type="number"] {
            background-color: var(--bg-dark); border-color: var(--border-color-dark); color: var(--text-color-dark);
        }

        /* Dark Toggle */
        .toggle-dark {
            position: relative; display: inline-block; width: 60px; height: 34px;
            border-radius: 34px; background-color: var(--border-color-light); cursor: pointer; margin-left: 20px;
        }
        body.dark .toggle-dark { background-color: var(--bg-dark); border-color: var(--border-color-dark); }
        .toggle-dark input { opacity: 0; width: 0; height: 0; }
        .toggle-thumb {
            position: absolute; top: 2px; left: 2px; width: 26px; height: 26px;
            background-color: var(--primary-color); border-radius: 50%; transition: all 0.3s;
        }
        body.dark .toggle-dark input:checked + .toggle-thumb { left: 28px; background-color: var(--accent-color); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(45, 36, 36, 0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--card-bg-light); padding: 30px; width: 90%; max-width: 500px; border-radius: 25px; text-align: center; position: relative; }
        body.dark .modal-content { background-color: var(--card-bg-dark); }
        .close-button { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; font-weight: bold; }

        footer { text-align: center; padding: 25px; font-weight: 600; margin-top: auto; }
    </style>
</head>
<body>

<header>
    <div class="logo-container">
        <h1 class="site-title">üêæ Pet'emote</h1>
    </div>
    <nav>
        <a href="#" id="link-analyzer" class="active-nav-link">Analyzer</a>
        <a href="#" id="link-articles">Articles</a>
        <a href="#" id="link-personalized-content">Advice</a>
        <a href="#" id="link-chatbot">Chat</a>
        <a href="#" id="link-profile">Profile</a>
        <label class="toggle-dark" for="darkToggle">
            <input type="checkbox" id="darkToggle" />
            <span class="toggle-thumb"></span>
        </label>
    </nav>
</header>

<main>
    <section id="analyzer" class="active">
        <h2 class="section-heading">Pet Emotion Analyzer üêæ</h2>
        <div class="analyzer-content">
            <p style="text-align: center;">Upload an image of your dog or cat to understand their emotions!</p>
            <div class="file-input-wrapper">
                <input type="file" id="imageUpload" accept="image/*" class="file-input">
                <label for="imageUpload" class="file-input-label">Tap to Select Image</label>
            </div>
            <img id="imagePreview" src="#" alt="Image Preview">
            <button id="analyzeButton" style="background-color: var(--primary-color); color: white; width:100%; margin-top:20px;">Analyze Emotion</button>
            <div id="loadingSpinner" class="loading-spinner"></div>
            <div id="resultDisplay">
                <h2>Emotion Analysis:</h2>
                <p id="emotionText">Upload an image and click 'Analyze Emotion' to see results.</p>
            </div>
        </div>
    </section>

    <section id="articles">
        <h2 class="section-heading">Expert Articles üìñ</h2>
        <div id="articlesContainer"></div>
    </section>

    <section id="personalized-content">
        <h2 class="section-heading">Tailored Advice ü¶¥</h2>
        <div style="background-color: var(--bg-light); padding: 30px; border-radius: 25px; border: 2px dashed var(--border-color-light);">
            <input type="text" id="petName" placeholder="Pet's Name">
            <input type="text" id="petBreed" placeholder="Breed">
            <input type="number" id="petAge" placeholder="Age (years)">
            <input type="text" id="petWeight" placeholder="Weight">
            <button id="generateContentButton" style="background-color: var(--accent-color); color: white; width: 100%;">Generate Advice</button>
            <div id="personalizedLoadingSpinner" class="loading-spinner"></div>
        </div>
        <div id="personalizedResultDisplay">
            <h3>Your Advice:</h3>
            <div id="personalizedContentText">Enter details above to see recommendations.</div>
        </div>
    </section>

    <section id="chatbot">
        <h2 class="section-heading">Chat with Pet'emote üí¨</h2>
        <div class="chatbot-container">
            <div id="chat-window" class="chat-window">
                <div class="chat-message bot">Hello! How can I help you with your pet today?</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Ask about health, behavior...">
                <button id="send-chat-button">Send</button>
            </div>
        </div>
    </section>

    <section id="profile">
        <h2 class="section-heading">Your Profile üë§</h2>
        <div id="profileData" style="text-align:center;">
             <p><strong>User:</strong> <span id="profileUid">Guest</span></p>
        </div>
        <button id="logoutButton" style="background-color: #FF6B6B; width: 100%; margin-top:20px;">Logout</button>
    </section>
</main>

<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <p id="modalMessage"></p>
    </div>
</div>

<div id="articleModal" class="modal">
    <div class="modal-content" style="text-align: left; max-height: 80vh; overflow-y: auto;">
        <span class="close-button" id="closeArticleModal">&times;</span>
        <h3 id="articleModalTitle"></h3>
        <div id="articleModalContent"></div>
    </div>
</div>

<footer><p>&copy; 2025 Pet'emote.</p></footer>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

<script>
    // --- Firebase Init ---
    const firebaseConfig = {
        apiKey: "AIzaSyAcNOMZNSC5vmhb4vgFP4Rr1KQH0hCD1iY",
        authDomain: "pet-emote.firebaseapp.com",
        projectId: "pet-emote",
        appId: "1:560806298260:web:8724cda11543d877d52a81"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // --- SECURE API CALLER ---
    // This calls your internal Vercel function, NOT Google directly.
    async function fetchFromBackend(payload) {
        try {
            const response = await fetch('/api/gemini', { // Points to your secure backend file
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('API Error');
            return await response.json();
        } catch (e) {
            console.error(e);
            alert("Error connecting to server. Make sure you deployed the 'api' folder!");
            throw e;
        }
    }

    // --- Navigation & UI ---
    const sections = {
        'analyzer': document.getElementById('analyzer'),
        'articles': document.getElementById('articles'),
        'personalized-content': document.getElementById('personalized-content'),
        'chatbot': document.getElementById('chatbot'),
        'profile': document.getElementById('profile')
    };

    function showSection(id) {
        Object.values(sections).forEach(el => { el.style.display = 'none'; el.classList.remove('active'); });
        document.querySelectorAll('nav a').forEach(el => el.classList.remove('active-nav-link'));
        
        const target = sections[id];
        if (target) {
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 10);
            const link = document.getElementById(`link-${id}`);
            if (link) link.classList.add('active-nav-link');
        }
    }

    ['analyzer', 'articles', 'personalized-content', 'chatbot', 'profile'].forEach(id => {
        document.getElementById(`link-${id}`).addEventListener('click', (e) => {
            e.preventDefault(); showSection(id);
        });
    });

    // Dark Mode
    document.getElementById('darkToggle').addEventListener('change', (e) => {
        document.body.classList.toggle('dark', e.target.checked);
    });

    // --- 1. Analyzer Logic ---
    let uploadedBase64 = null;
    let mimeType = null;
    document.getElementById('imageUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            mimeType = file.type;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('imagePreview').src = ev.target.result;
                document.getElementById('imagePreview').style.display = 'block';
                uploadedBase64 = ev.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('analyzeButton').addEventListener('click', async () => {
        if (!uploadedBase64) return alert("Please upload an image first");
        document.getElementById('loadingSpinner').style.display = 'block';
        
        try {
            const result = await fetchFromBackend({
                contents: [{
                    role: "user",
                    parts: [
                        { text: "Analyze the emotion of the pet in this image." },
                        { inlineData: { mimeType: mimeType, data: uploadedBase64 } }
                    ]
                }]
            });
            document.getElementById('emotionText').innerText = result.candidates[0].content.parts[0].text;
        } catch(e) {} 
        finally { document.getElementById('loadingSpinner').style.display = 'none'; }
    });

    // --- 2. Chatbot Logic ---
    document.getElementById('send-chat-button').addEventListener('click', async () => {
        const input = document.getElementById('chat-input');
        const text = input.value;
        if (!text) return;

        const win = document.getElementById('chat-window');
        win.innerHTML += `<div class="chat-message user">${text}</div>`;
        input.value = '';

        try {
            // Note: For a real chat history, you'd append previous messages here
            const result = await fetchFromBackend({
                contents: [{ role: "user", parts: [{ text: text }] }]
            });
            const botText = result.candidates[0].content.parts[0].text;
            win.innerHTML += `<div class="chat-message bot">${botText}</div>`;
        } catch (e) {
            win.innerHTML += `<div class="chat-message bot">Error connecting.</div>`;
        }
        win.scrollTop = win.scrollHeight;
    });

    // --- 3. Personalized Advice ---
    document.getElementById('generateContentButton').addEventListener('click', async () => {
        const name = document.getElementById('petName').value;
        if (!name) return alert("Enter pet name");
        
        document.getElementById('personalizedLoadingSpinner').style.display = 'block';
        const prompt = `Give advice for a pet named ${name} who is a ${document.getElementById('petBreed').value}.`;
        
        try {
            const result = await fetchFromBackend({
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            });
            const converter = new showdown.Converter();
            document.getElementById('personalizedContentText').innerHTML = converter.makeHtml(result.candidates[0].content.parts[0].text);
        } catch(e) {}
        finally { document.getElementById('personalizedLoadingSpinner').style.display = 'none'; }
    });

    // --- 4. Articles (Mock Data) ---
    const articlesData = [
        { title: "Understanding Body Language", summary: "Learn to read tail wags and ear positions.", content: "Full article content here..." },
        { title: "Separation Anxiety", summary: "How to help your pet feel safe alone.", content: "Full article content here..." }
    ];
    const artContainer = document.getElementById('articlesContainer');
    articlesData.forEach((art, i) => {
        const div = document.createElement('div');
        div.className = 'article-card'; // Styling handled by CSS
        div.innerHTML = `<h3>${art.title}</h3><p>${art.summary}</p><button onclick="openArticle(${i})">Read</button>`;
        artContainer.appendChild(div);
    });
    
    window.openArticle = (i) => {
        document.getElementById('articleModalTitle').innerText = articlesData[i].title;
        document.getElementById('articleModalContent').innerText = articlesData[i].content;
        document.getElementById('articleModal').style.display = 'flex';
    };
    
    // Modal Closing
    document.querySelectorAll('.close-button').forEach(btn => btn.onclick = () => {
        btn.closest('.modal').style.display = 'none';
    });
    window.onclick = (e) => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };
    
    // Auth Listener
    auth.onAuthStateChanged(user => {
        document.getElementById('profileUid').innerText = user ? user.uid : "Not logged in";
    });
    document.getElementById('logoutButton').addEventListener('click', () => auth.signOut());

</script>
</body>
</html>
